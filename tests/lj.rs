// lj.rs
// :PROPERTIES:
// :header-args: :tangle tests/lj.rs
// :END:

// [[file:~/Workspace/Programming/rust-scratch/fire/fire.note::*lj.rs][lj.rs:1]]
#[test]
fn test_fire_opt() {
    use fire::lj::LennardJones;
    use fire::*;
    use vecfx::*;

    // LJ38
    let mut positions = [
    50.27754123,     50.04898929,     50.13164926,
    49.54021264,     50.20208324,     49.33142540,
    50.36795885,     50.91366213,     49.53932153,
    49.71004612,     49.12254218,     50.30950773,
    51.59992702,     50.93225616,     49.75465016,
    49.54096326,     50.01499737,     50.89785480,
    49.27589571,     49.40276757,     51.78288271,
    50.84293978,     51.39416756,     50.37578558,
    50.85011555,     49.18468518,     49.88733738,
    50.48954837,     48.31866393,     50.39752223,
    49.54570033,     50.99619360,     50.39370291,
    50.83198382,     49.97838559,     49.15111253,
    48.68259959,     51.76333286,     50.71665986,
    48.78703201,     50.74137148,     48.70964574,
    50.46846546,     50.64822201,     51.05913458,
    50.32617974,     51.72202742,     51.25600177,
    48.98719425,     48.57072315,     50.86630469,
    49.41532317,     48.01960200,     49.86479222,
    50.33160898,     51.97929717,     49.55667898,
    50.05747126,     48.65423592,     51.34871762,
    49.47506697,     52.40222682,     50.09998700,
    50.08941533,     50.76191893,     48.51033008,
    49.66096522,     52.51096459,     51.72590563,
    49.26806275,     51.61276429,     49.24438196,
    51.33222714,     48.66903395,     51.03264292,
    48.82443599,     48.10619401,     51.83279474,
    49.32661434,     51.45251656,     51.52447147,
    48.60626152,     50.67040668,     51.00622736,
    48.66876297,     50.02851267,     49.95976353,
    48.45421774,     49.58111803,     50.93806524,
    49.23169585,     49.11782673,     49.33972073,
    50.51551634,     47.49882067,     49.67074204,
    50.53443706,     49.65001264,     51.43455000,
    51.64327906,     48.46431354,     49.94896031,
    51.54629763,     49.42747135,     51.83066872,
    49.51504504,     50.47172337,     51.84485663,
    49.10265035,     52.00399992,     52.61150826,
    49.66462610,     47.60012985,     50.93620680];

    let mut lj = LennardJones::default();

    // fire()
    //     .with_max_step(0.2)
    //     .with_max_gradient_norm(0.4)
    //     .minimize(&mut positions, |x, forces| {
    //         let energy = lj.evaluate(x.as_3d(), forces.as_mut_3d());
    //         energy
    //     });

    // alternative interface
    fire()
        .with_max_step(0.2)
        .with_max_cycles(1000)
        .with_max_gradient_norm(0.1)
        .minimize_alt(
            &mut positions,
            |x, gx| {
                let energy = lj.evaluate(x.as_3d(), gx.as_mut_3d());
                gx.vecscale(-1.0);
                energy
            },
            monitor(|prgr| {
                prgr.report();
                false
            }),
        );

    let positions = [
        [50.44589968, 50.1737282, 50.58752237],
        [49.6396638, 50.08512913, 49.87932046],
        [50.58591754, 50.66022292, 49.63014864],
        [49.92543195, 49.2747952, 50.52344688],
        [51.44501837, 50.13816815, 50.18874272],
        [49.37829706, 50.16043128, 50.9131613],
        [49.28378556, 49.12263796, 51.35901922],
        [50.9953407, 51.08895038, 50.59285523],
        [50.60485711, 49.55330033, 49.73398556],
        [50.5692866, 48.51270266, 50.10100953],
        [49.86521272, 51.02744187, 50.40419086],
        [51.31402688, 50.01702542, 49.07558704],
        [48.82820491, 51.28025666, 50.20328413],
        [48.93557108, 49.75311256, 49.14585085],
        [50.21839251, 50.77835502, 51.42890129],
        [50.32123474, 51.80493451, 51.06329693],
        [48.49343695, 48.51454902, 50.88832253],
        [49.71618787, 49.01652145, 49.46771167],
        [50.45069591, 51.74455313, 49.86076544],
        [50.27076381, 48.54922018, 51.22569334],
        [49.52649545, 52.09666112, 50.37319513],
        [50.05479187, 50.00275686, 48.89145971],
        [49.49562014, 52.42710598, 51.45641218],
        [49.56803878, 51.03695082, 49.35823071],
        [51.00668233, 49.27370845, 50.78066818],
        [49.31776714, 48.02245809, 51.47028994],
        [49.28415626, 51.37569792, 51.21916131],
        [48.44077305, 50.71931659, 51.11205569],
        [48.57867969, 50.24482085, 50.10825257],
        [48.37933547, 49.63430011, 51.03574439],
        [48.92040384, 49.23343231, 50.17456549],
        [49.886296, 47.92405034, 49.45097733],
        [50.2225615, 49.67070039, 51.51953789],
        [51.56378741, 49.07817099, 49.82756402],
        [51.21394056, 50.24189926, 51.32726023],
        [49.26878184, 50.51872647, 51.92559874],
        [49.8818889, 51.57269516, 52.10452823],
        [49.49105854, 48.30867265, 50.41415337],
    ];

    let mut gx = vec![[0.0; 3]; 38];
    let e = lj.evaluate(&positions, &mut gx);
    println!("{:#?}", e);
}
// lj.rs:1 ends here
